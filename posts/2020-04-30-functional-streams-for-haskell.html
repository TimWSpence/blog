<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>My Hakyll Blog - Functional streams for Haskell</title>
        <link rel="stylesheet" href="../stylesheet.css" />
    </head>
    <body>
        <header>
            <nav>
                <a href="../">Home</a>
                <a href="../about.html">About</a>
                <a href="../archive.html">Archive</a>
            </nav>
        </header>

        <main role="main">
            <h1>Functional streams for Haskell</h1>
            <article>
    <section class="header">
        Posted on April 30, 2020
        
    </section>
    <section>
        <p>Popular Haskell streaming libraries such as <a href="https://hackage.haskell.org/package/conduit">Conduit</a> and <a href="https://hackage.haskell.org/package/pipes">Pipes</a> expose a top-level type that looks something like <code>Stream m a r</code> where <code>m</code> is an effect type, <code>a</code> is the type of the elements in the stream and <code>r</code> is the result type of the stream. In other words, they are functorial in the result of the stream. Scala’s <a href="https://fs2.io/">fs2</a> library takes a different approach whereby it is functorial in the element type of the stream instead - <code>Stream m a</code> and the result type is determined by the way you run the stream, rather than the stream itself (eg <code>toFile :: FilePath -&gt; Stream m String -&gt; IO ()</code>).</p>
<p>The following is an experiment in starting with that idea, picking the first stream representation that came into my head and typing for a couple of hours. I think the result is surprisingly expressive (if <em>very</em> inefficient)! See the examples at the end for what usage looks like.</p>
<p><code>example2</code> in particular illustrates the part of the API which is a bit more painful (AFAIK) in Pipes or Conduit - dynamically generating and concatenating substreams. In my experience, I’ve had to resort to lower level APIs to achieve that in these libraries (although it is entirely possibly that I missed a combinator somewhere - I have limited experience of both). Regardless, I was surprised how much functionality could be implemented in such a short time and amount of code by representing streams as data structures with interpreters.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="ot">{-# LANGUAGE GADTs #-}</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="ot">{-# LANGUAGE KindSignatures #-}</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="ot">{-# LANGUAGE TupleSections #-}</span></a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">module</span> <span class="dt">Streaming</span></a>
<a class="sourceLine" id="cb1-6" title="6">  (</a>
<a class="sourceLine" id="cb1-7" title="7">  )</a>
<a class="sourceLine" id="cb1-8" title="8"><span class="kw">where</span></a>
<a class="sourceLine" id="cb1-9" title="9"></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="kw">import</span> <span class="dt">Data.Functor.Identity</span></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="kw">import</span> <span class="dt">Control.Applicative</span></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="kw">import</span> <span class="dt">Control.Monad</span></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="kw">import</span> <span class="dt">Data.Monoid</span></a>
<a class="sourceLine" id="cb1-14" title="14"><span class="kw">import</span> <span class="dt">System.IO</span></a>
<a class="sourceLine" id="cb1-15" title="15"></a>
<a class="sourceLine" id="cb1-16" title="16"><span class="co">-- Represents a stream of elements of type a with an effect type f</span></a>
<a class="sourceLine" id="cb1-17" title="17"><span class="kw">data</span> <span class="dt">Stream</span> (<span class="ot">m ::</span> <span class="fu">*</span> <span class="ot">-&gt;</span> <span class="fu">*</span>) a <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-18" title="18">  <span class="dt">Yield</span><span class="ot"> ::</span> m a <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a</a>
<a class="sourceLine" id="cb1-19" title="19">  <span class="dt">Await</span><span class="ot"> ::</span> m x <span class="ot">-&gt;</span> (x <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a) <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a</a>
<a class="sourceLine" id="cb1-20" title="20">  <span class="dt">Concat</span><span class="ot"> ::</span> <span class="dt">Stream</span> m a <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a</a>
<a class="sourceLine" id="cb1-21" title="21">  <span class="dt">Done</span><span class="ot"> ::</span> m () <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a</a>
<a class="sourceLine" id="cb1-22" title="22"></a>
<a class="sourceLine" id="cb1-23" title="23"><span class="kw">instance</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Functor</span> (<span class="dt">Stream</span> m) <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-24" title="24">  <span class="fu">fmap</span> <span class="fu">=</span> liftM</a>
<a class="sourceLine" id="cb1-25" title="25"></a>
<a class="sourceLine" id="cb1-26" title="26"><span class="kw">instance</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Applicative</span> (<span class="dt">Stream</span> m) <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-27" title="27">  <span class="fu">pure</span> <span class="fu">=</span> <span class="fu">return</span></a>
<a class="sourceLine" id="cb1-28" title="28"></a>
<a class="sourceLine" id="cb1-29" title="29">  (<span class="fu">&lt;*&gt;</span>) <span class="fu">=</span> ap</a>
<a class="sourceLine" id="cb1-30" title="30"></a>
<a class="sourceLine" id="cb1-31" title="31"><span class="kw">instance</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Monad</span> (<span class="dt">Stream</span> m) <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-32" title="32">  <span class="fu">return</span> a <span class="fu">=</span> <span class="dt">Yield</span> (<span class="fu">return</span> a) (<span class="dt">Done</span> (<span class="fu">return</span> ()))</a>
<a class="sourceLine" id="cb1-33" title="33"></a>
<a class="sourceLine" id="cb1-34" title="34">  (<span class="dt">Yield</span> ma next) <span class="fu">&gt;&gt;=</span> f <span class="fu">=</span> <span class="dt">Concat</span> (<span class="dt">Await</span> ma f) (next <span class="fu">&gt;&gt;=</span> f)</a>
<a class="sourceLine" id="cb1-35" title="35">  (<span class="dt">Await</span> ma cont) <span class="fu">&gt;&gt;=</span> f <span class="fu">=</span> <span class="dt">Await</span> ma (cont <span class="fu">&gt;=&gt;</span> f)</a>
<a class="sourceLine" id="cb1-36" title="36">  (<span class="dt">Concat</span> s1 s2) <span class="fu">&gt;&gt;=</span> f <span class="fu">=</span> <span class="dt">Concat</span> (s1 <span class="fu">&gt;&gt;=</span> f) (s2 <span class="fu">&gt;&gt;=</span> f)</a>
<a class="sourceLine" id="cb1-37" title="37">  (<span class="dt">Done</span> close) <span class="fu">&gt;&gt;=</span> f <span class="fu">=</span> <span class="dt">Done</span> close</a>
<a class="sourceLine" id="cb1-38" title="38"></a>
<a class="sourceLine" id="cb1-39" title="39"><span class="kw">instance</span> <span class="dt">Semigroup</span> (<span class="dt">Stream</span> m a) <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-40" title="40">  (<span class="fu">&lt;&gt;</span>) <span class="fu">=</span> <span class="dt">Concat</span></a>
<a class="sourceLine" id="cb1-41" title="41"></a>
<a class="sourceLine" id="cb1-42" title="42"><span class="kw">instance</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Monoid</span> (<span class="dt">Stream</span> m a) <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-43" title="43">  <span class="fu">mempty</span> <span class="fu">=</span> <span class="dt">Done</span> (<span class="fu">return</span> ())</a>
<a class="sourceLine" id="cb1-44" title="44">  <span class="fu">mappend</span> <span class="fu">=</span> (<span class="fu">&lt;&gt;</span>)</a>
<a class="sourceLine" id="cb1-45" title="45"></a>
<a class="sourceLine" id="cb1-46" title="46"><span class="ot">fromList ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a</a>
<a class="sourceLine" id="cb1-47" title="47">fromList [] <span class="fu">=</span> <span class="dt">Done</span> (<span class="fu">return</span> ())</a>
<a class="sourceLine" id="cb1-48" title="48">fromList (h <span class="fu">:</span> t) <span class="fu">=</span> <span class="dt">Yield</span> (<span class="fu">return</span> h) (fromList t)</a>
<a class="sourceLine" id="cb1-49" title="49"></a>
<a class="sourceLine" id="cb1-50" title="50"><span class="ot">fromStdIn ::</span> <span class="dt">Stream</span> <span class="dt">IO</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb1-51" title="51">fromStdIn <span class="fu">=</span> <span class="dt">Await</span> <span class="fu">getLine</span> <span class="fu">return</span></a>
<a class="sourceLine" id="cb1-52" title="52"></a>
<a class="sourceLine" id="cb1-53" title="53"><span class="ot">fromFile ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Stream</span> <span class="dt">IO</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb1-54" title="54">fromFile file <span class="fu">=</span> <span class="dt">Await</span> handle cont</a>
<a class="sourceLine" id="cb1-55" title="55">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-56" title="56">    handle <span class="fu">=</span> (openFile file <span class="dt">ReadMode</span>) <span class="fu">&gt;&gt;=</span> handleStatus</a>
<a class="sourceLine" id="cb1-57" title="57">    handleStatus h <span class="fu">=</span> <span class="fu">fmap</span> (h,) (hIsEOF h)</a>
<a class="sourceLine" id="cb1-58" title="58">    cont (h, isClosed) <span class="fu">=</span> <span class="kw">if</span> (isClosed) <span class="kw">then</span> <span class="dt">Done</span> (hClose h) <span class="kw">else</span> <span class="dt">Yield</span> (hGetLine h) (<span class="dt">Await</span> (handleStatus h) cont)</a>
<a class="sourceLine" id="cb1-59" title="59"></a>
<a class="sourceLine" id="cb1-60" title="60"><span class="ot">toFile ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Stream</span> <span class="dt">IO</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb1-61" title="61">toFile file stream <span class="fu">=</span> withFile file <span class="dt">WriteMode</span> <span class="fu">$</span> \h <span class="ot">-&gt;</span> drain <span class="fu">.</span> mapF (hPutStrLn h) <span class="fu">$</span> stream</a>
<a class="sourceLine" id="cb1-62" title="62"></a>
<a class="sourceLine" id="cb1-63" title="63"><span class="ot">toList ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Stream</span> m a <span class="ot">-&gt;</span> m [a]</a>
<a class="sourceLine" id="cb1-64" title="64">toList (<span class="dt">Yield</span> ma next) <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-65" title="65">  h <span class="ot">&lt;-</span> ma</a>
<a class="sourceLine" id="cb1-66" title="66">  t <span class="ot">&lt;-</span> toList next</a>
<a class="sourceLine" id="cb1-67" title="67">  <span class="fu">return</span> (h <span class="fu">:</span> t)</a>
<a class="sourceLine" id="cb1-68" title="68">toList (<span class="dt">Await</span> ma cont) <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-69" title="69">  a <span class="ot">&lt;-</span> ma</a>
<a class="sourceLine" id="cb1-70" title="70">  toList (cont a)</a>
<a class="sourceLine" id="cb1-71" title="71">toList (<span class="dt">Concat</span> s1 s2) <span class="fu">=</span> liftA2 (<span class="fu">&lt;&gt;</span>) (toList s1) (toList s2)</a>
<a class="sourceLine" id="cb1-72" title="72">toList (<span class="dt">Done</span> close) <span class="fu">=</span> close <span class="fu">&gt;&gt;</span> <span class="fu">return</span> []</a>
<a class="sourceLine" id="cb1-73" title="73"></a>
<a class="sourceLine" id="cb1-74" title="74"><span class="ot">fold ::</span> (<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> (b <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> b <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a <span class="ot">-&gt;</span> m b</a>
<a class="sourceLine" id="cb1-75" title="75">fold f b (<span class="dt">Yield</span> ma next) <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-76" title="76">  b' <span class="ot">&lt;-</span> <span class="fu">fmap</span> (f b) ma</a>
<a class="sourceLine" id="cb1-77" title="77">  fold f (b') next</a>
<a class="sourceLine" id="cb1-78" title="78">fold f b (<span class="dt">Await</span> ma cont) <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-79" title="79">  a <span class="ot">&lt;-</span> ma</a>
<a class="sourceLine" id="cb1-80" title="80">  fold f b (cont a)</a>
<a class="sourceLine" id="cb1-81" title="81">fold f b (<span class="dt">Concat</span> s1 s2) <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-82" title="82">  b' <span class="ot">&lt;-</span> fold f b s1</a>
<a class="sourceLine" id="cb1-83" title="83">  fold f b' s2</a>
<a class="sourceLine" id="cb1-84" title="84">fold _ b (<span class="dt">Done</span> close) <span class="fu">=</span> close <span class="fu">&gt;&gt;</span> <span class="fu">return</span> b</a>
<a class="sourceLine" id="cb1-85" title="85"></a>
<a class="sourceLine" id="cb1-86" title="86"><span class="ot">foldMonoid ::</span> (<span class="dt">Monad</span> m, <span class="dt">Monoid</span> a) <span class="ot">=&gt;</span> <span class="dt">Stream</span> m a <span class="ot">-&gt;</span> m a</a>
<a class="sourceLine" id="cb1-87" title="87">foldMonoid <span class="fu">=</span> fold (<span class="fu">&lt;&gt;</span>) <span class="fu">mempty</span></a>
<a class="sourceLine" id="cb1-88" title="88"></a>
<a class="sourceLine" id="cb1-89" title="89"><span class="co">-- Run a stream purely for its effects</span></a>
<a class="sourceLine" id="cb1-90" title="90"><span class="ot">drain ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Stream</span> m a <span class="ot">-&gt;</span> m ()</a>
<a class="sourceLine" id="cb1-91" title="91">drain (<span class="dt">Yield</span> ma next) <span class="fu">=</span> ma <span class="fu">&gt;&gt;</span> drain next</a>
<a class="sourceLine" id="cb1-92" title="92">drain (<span class="dt">Await</span> ma cont) <span class="fu">=</span> ma <span class="fu">&gt;&gt;=</span> (drain <span class="fu">.</span> cont)</a>
<a class="sourceLine" id="cb1-93" title="93">drain (<span class="dt">Concat</span> s1 s2) <span class="fu">=</span> drain s1 <span class="fu">&gt;&gt;</span> drain s2</a>
<a class="sourceLine" id="cb1-94" title="94">drain (<span class="dt">Done</span> close) <span class="fu">=</span> close</a>
<a class="sourceLine" id="cb1-95" title="95"></a>
<a class="sourceLine" id="cb1-96" title="96"><span class="co">-- Map an effectful computation across a stream</span></a>
<a class="sourceLine" id="cb1-97" title="97"><span class="ot">mapF ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> m b) <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a <span class="ot">-&gt;</span> <span class="dt">Stream</span> m b</a>
<a class="sourceLine" id="cb1-98" title="98">mapF f (<span class="dt">Yield</span> ma next) <span class="fu">=</span> <span class="dt">Yield</span> (ma <span class="fu">&gt;&gt;=</span> f) (mapF f next)</a>
<a class="sourceLine" id="cb1-99" title="99">mapF f (<span class="dt">Await</span> ma cont) <span class="fu">=</span> <span class="dt">Await</span> ma (mapF f <span class="fu">.</span> cont)</a>
<a class="sourceLine" id="cb1-100" title="100">mapF f (<span class="dt">Concat</span> s1 s2) <span class="fu">=</span> <span class="dt">Concat</span> (mapF f s1) (mapF f s2)</a>
<a class="sourceLine" id="cb1-101" title="101">mapF f (<span class="dt">Done</span> close) <span class="fu">=</span> <span class="dt">Done</span> close</a>
<a class="sourceLine" id="cb1-102" title="102"></a>
<a class="sourceLine" id="cb1-103" title="103"><span class="co">-- Print each line in /tmp/data in turn</span></a>
<a class="sourceLine" id="cb1-104" title="104"><span class="ot">example1 ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb1-105" title="105">example1 <span class="fu">=</span> drain <span class="fu">.</span> mapF <span class="fu">putStrLn</span> <span class="fu">$</span> fromFile <span class="st">&quot;/tmp/data&quot;</span></a>
<a class="sourceLine" id="cb1-106" title="106"></a>
<a class="sourceLine" id="cb1-107" title="107"><span class="co">-- Duplicate every element in the input list -&gt; [1,1,2,2,3,3]</span></a>
<a class="sourceLine" id="cb1-108" title="108"><span class="ot">example2 ::</span> [<span class="dt">Int</span>]</a>
<a class="sourceLine" id="cb1-109" title="109">example2 <span class="fu">=</span> runIdentity <span class="fu">.</span> toList <span class="fu">.</span> (<span class="fu">&gt;&gt;=</span> \x <span class="ot">-&gt;</span> <span class="fu">return</span> x <span class="fu">&lt;&gt;</span> <span class="fu">return</span> x) <span class="fu">$</span> fromList [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]</a>
<a class="sourceLine" id="cb1-110" title="110"></a>
<a class="sourceLine" id="cb1-111" title="111"><span class="co">-- Concatenate files to list</span></a>
<a class="sourceLine" id="cb1-112" title="112"><span class="ot">example3 ::</span> <span class="dt">IO</span> [<span class="dt">String</span>]</a>
<a class="sourceLine" id="cb1-113" title="113">example3 <span class="fu">=</span> toList <span class="fu">$</span> (fromFile <span class="st">&quot;/tmp/data&quot;</span>) <span class="fu">&lt;&gt;</span> (fromFile <span class="st">&quot;/tmp/data2&quot;</span>)</a>
<a class="sourceLine" id="cb1-114" title="114"></a>
<a class="sourceLine" id="cb1-115" title="115"><span class="co">-- Sum list</span></a>
<a class="sourceLine" id="cb1-116" title="116"><span class="ot">example4 ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb1-117" title="117">example4 <span class="fu">=</span> getSum <span class="fu">.</span> runIdentity <span class="fu">.</span> foldMonoid <span class="fu">.</span> <span class="fu">fmap</span> <span class="dt">Sum</span> <span class="fu">$</span> fromList [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>]</a>
<a class="sourceLine" id="cb1-118" title="118"></a>
<a class="sourceLine" id="cb1-119" title="119"><span class="co">-- Copy file</span></a>
<a class="sourceLine" id="cb1-120" title="120"><span class="ot">example5 ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb1-121" title="121">example5 <span class="fu">=</span> toFile <span class="st">&quot;/tmp/copy&quot;</span> <span class="fu">$</span> fromFile <span class="st">&quot;/tmp/data&quot;</span></a></code></pre></div>
    </section>
</article>

        </main>

        <footer>
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </footer>
    </body>
</html>
