<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>My Hakyll Blog - Cats STM 0.7.0</title>
        <link rel="stylesheet" href="../stylesheet.css" />
    </head>
    <body>
        <header>
            <nav>
                <a href="../">Home</a>
                <a href="../about.html">About</a>
                <a href="../archive.html">Archive</a>
            </nav>
        </header>

        <main role="main">
            <h1>Cats STM 0.7.0</h1>
            <article>
    <section class="header">
        Posted on February 14, 2020
        
    </section>
    <section>
        <p>Today marks the release of version 0.7.0 of <a href="https://github.com/TimWSpence/cats-stm">Cats STM</a> with several significant bug fixes and improvements to the fairness of retry scheduling.</p>
<p>If you are not familiar with the concept of STM (Software Transactional Memory) then you should definitely read the wonderful original paper <a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/beautiful.pdf">Beautiful Concurrency</a> or at least some of the docs for this library :D However, I will endeavour to give a very brief overview here.</p>
<p>The motivating observation is that the traditional tools for doing concurrent programming (mutexes, semaphores, etc) do not compose. Given two functions <code>f: A =&gt; B</code> and <code>g: B =&gt; C</code> each acquiring mutexes, we cannot reason about the locking behaviour of <code>f andThen g</code> in the presence of concurrency (see sections 2.1 and 2.2 of the paper).</p>
<p>The solution to this is the <code>STM</code> monad. This is compositional by definition (indeed, this practically <em>is</em> the definition of a monad) and exposes combinators such as</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">def</span> map[A, B](s: STM[A], f: A =&gt; B): STM[B]</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">def</span> orElse[A](attempt: STM[A], fallback: STM[A]): STM[A]</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">def</span> <span class="fu">check</span>(check: =&gt; Boolean): STM[Unit]</a></code></pre></div>
<p>How do we obtain a value of type <code>STM[A]</code> in the first place? These are returned by the operations defined on <code>TVar</code>s (transactional vars):</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">def</span> get: STM[A]</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw">def</span> <span class="fu">set</span>(a: A): STM[Unit]</a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw">def</span> <span class="fu">modify</span>(f: A =&gt; A): STM[Unit]</a></code></pre></div>
<p>A value of type <code>STM[A]</code> represents a computation that we would like to run atomically and which should return a value of type <code>A</code>. How do we do that? The clue’s in the name!</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">def</span> atomically[F[_], A](s: STM[A]): F[A]</a></code></pre></div>
<p>Why does this return something of type <code>F[A]</code> (assume this is <code>IO[A]</code> for simplicity’s sake) rather than something of type <code>A</code>? The execution of <code>atomically</code> is the point at which we acquire locks and mutate <code>TVar</code>s ie perform side effects and hence must be suspended in <code>IO</code>.</p>
<p>Here is a contrived example of what this looks like in practice. We use the <code>check</code> combinator to retry transferring money from Tim to Steve until we have enough money in Tim’s account:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">import</span> cats.<span class="fu">effect</span>.{ExitCode, IO, IOApp}</a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">import</span> io.<span class="fu">github</span>.<span class="fu">timwspence</span>.<span class="fu">cats</span>.<span class="fu">stm</span>.{TVar, STM}</a>
<a class="sourceLine" id="cb4-3" title="3"><span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">duration</span>._</a>
<a class="sourceLine" id="cb4-4" title="4"></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="kw">object</span> Main <span class="kw">extends</span> IOApp {</a>
<a class="sourceLine" id="cb4-6" title="6"></a>
<a class="sourceLine" id="cb4-7" title="7">  <span class="kw">override</span> <span class="kw">def</span> <span class="fu">run</span>(args: List[String]): IO[ExitCode] =</a>
<a class="sourceLine" id="cb4-8" title="8">    <span class="kw">for</span> {</a>
<a class="sourceLine" id="cb4-9" title="9">      accountForTim   &lt;- TVar.<span class="fu">of</span>[Long](<span class="dv">100</span>).<span class="fu">commit</span>[IO]</a>
<a class="sourceLine" id="cb4-10" title="10">      accountForSteve &lt;- TVar.<span class="fu">of</span>[Long](<span class="dv">0</span>).<span class="fu">commit</span>[IO]</a>
<a class="sourceLine" id="cb4-11" title="11">      _               &lt;- <span class="fu">printBalances</span>(accountForTim, accountForSteve)</a>
<a class="sourceLine" id="cb4-12" title="12">      _               &lt;- <span class="fu">giveTimMoreMoney</span>(accountForTim).<span class="fu">start</span></a>
<a class="sourceLine" id="cb4-13" title="13">      _               &lt;- <span class="fu">transfer</span>(accountForTim, accountForSteve)</a>
<a class="sourceLine" id="cb4-14" title="14">      _               &lt;- <span class="fu">printBalances</span>(accountForTim, accountForSteve)</a>
<a class="sourceLine" id="cb4-15" title="15">    } <span class="kw">yield</span> ExitCode.<span class="fu">Success</span></a>
<a class="sourceLine" id="cb4-16" title="16"></a>
<a class="sourceLine" id="cb4-17" title="17">  <span class="kw">private</span> <span class="kw">def</span> <span class="fu">transfer</span>(accountForTim: TVar[Long], accountForSteve: TVar[Long]): IO[Unit] =</a>
<a class="sourceLine" id="cb4-18" title="18">    STM.<span class="fu">atomically</span>[IO] {</a>
<a class="sourceLine" id="cb4-19" title="19">      <span class="kw">for</span> {</a>
<a class="sourceLine" id="cb4-20" title="20">        balance &lt;- accountForTim.<span class="fu">get</span></a>
<a class="sourceLine" id="cb4-21" title="21">        _       &lt;- STM.<span class="fu">check</span>(balance &gt; <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb4-22" title="22">        _       &lt;- accountForTim.<span class="fu">modify</span>(_ - <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb4-23" title="23">        _       &lt;- accountForSteve.<span class="fu">modify</span>(_ + <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb4-24" title="24">      } <span class="kw">yield</span> ()</a>
<a class="sourceLine" id="cb4-25" title="25">    }</a>
<a class="sourceLine" id="cb4-26" title="26"></a>
<a class="sourceLine" id="cb4-27" title="27">  <span class="kw">private</span> <span class="kw">def</span> <span class="fu">giveTimMoreMoney</span>(accountForTim: TVar[Long]): IO[Unit] =</a>
<a class="sourceLine" id="cb4-28" title="28">    <span class="kw">for</span> {</a>
<a class="sourceLine" id="cb4-29" title="29">      _ &lt;- IO.<span class="fu">sleep</span>(<span class="fl">5000.</span>millis)</a>
<a class="sourceLine" id="cb4-30" title="30">      _ &lt;- STM.<span class="fu">atomically</span>[IO](accountForTim.<span class="fu">modify</span>(_ + <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb4-31" title="31">    } <span class="kw">yield</span> ()</a>
<a class="sourceLine" id="cb4-32" title="32"></a>
<a class="sourceLine" id="cb4-33" title="33">  <span class="kw">private</span> <span class="kw">def</span> <span class="fu">printBalances</span>(accountForTim: TVar[Long], accountForSteve: TVar[Long]): IO[Unit] =</a>
<a class="sourceLine" id="cb4-34" title="34">    <span class="kw">for</span> {</a>
<a class="sourceLine" id="cb4-35" title="35">      (amountForTim, amountForSteve) &lt;- STM.<span class="fu">atomically</span>[IO](<span class="kw">for</span> {</a>
<a class="sourceLine" id="cb4-36" title="36">        t &lt;- accountForTim.<span class="fu">get</span></a>
<a class="sourceLine" id="cb4-37" title="37">        s &lt;- accountForSteve.<span class="fu">get</span></a>
<a class="sourceLine" id="cb4-38" title="38">      } <span class="kw">yield</span> (t, s))</a>
<a class="sourceLine" id="cb4-39" title="39">      _ &lt;- <span class="fu">IO</span>(<span class="fu">println</span>(s<span class="st">&quot;Tim: $amountForTim&quot;</span>))</a>
<a class="sourceLine" id="cb4-40" title="40">      _ &lt;- <span class="fu">IO</span>(<span class="fu">println</span>(s<span class="st">&quot;Steve: $amountForSteve&quot;</span>))</a>
<a class="sourceLine" id="cb4-41" title="41">    } <span class="kw">yield</span> ()</a>
<a class="sourceLine" id="cb4-42" title="42"></a>
<a class="sourceLine" id="cb4-43" title="43">}</a></code></pre></div>
<p>For a more involved example, see <a href="https://timwspence.github.io/cats-stm/tutorial/tutorial.html">The Santa Claus Problem</a> in the docs.</p>
<h2 id="the-importance-of-laws-testing">The importance of laws testing</h2>
<p>If you’ve followed cats-stm for a while, you may notice that the <a href="https://github.com/TimWSpence/cats-stm/blob/f9ca142d191eac143dbe2b4e0adafd48cae49db6/core/src/main/scala/io/github/timwspence/cats/stm/STM.scala#L119">Alternative instance for STM</a> has been removed. Upon adding laws testing, I discovered that it does not satisfy the alternative right-absorption and right-distributivity laws (and indeed I believe that STM cannot satisfy these laws in its current formulation). I’ve therefore downgraded it to a <code>MonoidK</code> instance, which can be lawfully implemented.</p>
<p>If you haven’t tried out law-testing before, please do!! It turns out to be immensely valuable! :D If we are unsure that a type conforms lawfully to a typeclass then we cannot safely refactor operations of that typeclass on that type.</p>
<h2 id="open-source-at-permutive">Open source at Permutive</h2>
<p>I’ve been lucky enough to get to write this library as part of my work for Permutive. Hopefully if you’re a Scala developer you will have already noticed that Permutive is making significant contributions to the open source Scala community through the work of <a href="https://github.com/travisbrown">Travis Brown</a>. Hopefully this post has convinced you that we have a wider commitment to open source and community contribution, both in Scala and (watch this space) Haskell. Come join us!</p>
    </section>
</article>

        </main>

        <footer>
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </footer>
    </body>
</html>
