<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>My Hakyll Blog - Functional streams for Haskell Part 2</title>
        <link rel="stylesheet" href="../stylesheet.css" />
    </head>
    <body>
        <header>
            <nav>
                <a href="../">Home</a>
                <a href="../about.html">About</a>
                <a href="../archive.html">Archive</a>
            </nav>
        </header>

        <main role="main">
            <h1>Functional streams for Haskell Part 2</h1>
            <article>
    <section class="header">
        Posted on April 30, 2020
        
    </section>
    <section>
        <p>In <a href="./2020-04-30-functional-streams-for-haskell.md">part 1</a> we developed a simple streaming library based on the first stream representation that popped into my head, which happened to be:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">data</span> <span class="dt">Stream</span> (<span class="ot">m ::</span> <span class="fu">*</span> <span class="ot">-&gt;</span> <span class="fu">*</span>) a <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-2" title="2">  <span class="dt">Yield</span><span class="ot"> ::</span> m a <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a</a>
<a class="sourceLine" id="cb1-3" title="3">  <span class="dt">Await</span><span class="ot"> ::</span> m x <span class="ot">-&gt;</span> (x <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a) <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a</a>
<a class="sourceLine" id="cb1-4" title="4">  <span class="dt">Done</span><span class="ot"> ::</span> m () <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a</a></code></pre></div>
<p>Initially this seemed promising and indeed we got quite far with this representation. However, the wheels start to come off when we attempt to implement <code>filter</code>. The problem is that weâ€™re conflating to separate concepts: emitting elements of the stream and performing effects. Consider how we would define <code>filter</code> for <code>Yield ma cont</code>. There is no simply no way to apply the filter function before making a decision about whether to sequence the effect to emit <code>ma</code>.</p>
<p>This leads us to a different representation which separates the emitting of elements from the performing of effects:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">data</span> <span class="dt">Stream</span> (<span class="ot">m ::</span> <span class="fu">*</span> <span class="ot">-&gt;</span> <span class="fu">*</span>) a <span class="kw">where</span></a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="dt">Yield</span><span class="ot"> ::</span> a <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a</a>
<a class="sourceLine" id="cb2-3" title="3">  <span class="dt">Await</span><span class="ot"> ::</span> m x <span class="ot">-&gt;</span> (x <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a) <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a</a>
<a class="sourceLine" id="cb2-4" title="4">  <span class="dt">Eff</span><span class="ot"> ::</span> m (<span class="dt">Stream</span> m a) <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a</a>
<a class="sourceLine" id="cb2-5" title="5">  <span class="dt">Done</span><span class="ot"> ::</span> m () <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a</a></code></pre></div>
<p>And indeed this works! We can now define filter:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1"><span class="ot">filterS ::</span> <span class="dt">Functor</span> m <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> <span class="dt">Bool</span>) <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a</a>
<a class="sourceLine" id="cb3-2" title="2">filterS f (<span class="dt">Yield</span> a next) <span class="fu">=</span> <span class="kw">if</span> f a <span class="kw">then</span> <span class="dt">Yield</span> a (filterS f next) <span class="kw">else</span> filterS f next</a>
<a class="sourceLine" id="cb3-3" title="3">filterS f (<span class="dt">Await</span> ma cont) <span class="fu">=</span> <span class="dt">Await</span> ma (filterS f <span class="fu">.</span> cont)</a>
<a class="sourceLine" id="cb3-4" title="4">filterS f (<span class="dt">Eff</span> ms) <span class="fu">=</span> <span class="dt">Eff</span> <span class="fu">.</span> <span class="fu">fmap</span> (filterS f) <span class="fu">$</span> ms</a>
<a class="sourceLine" id="cb3-5" title="5">filterS _ (<span class="dt">Done</span> close) <span class="fu">=</span> <span class="dt">Done</span> close</a></code></pre></div>
<p>For completeness, here is the rest of the code updated to this new model, along with an example demonstrating <code>filterS</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" title="1"><span class="ot">{-# LANGUAGE GADTs #-}</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="ot">{-# LANGUAGE KindSignatures #-}</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="ot">{-# LANGUAGE TupleSections #-}</span></a>
<a class="sourceLine" id="cb4-4" title="4"></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="kw">module</span> <span class="dt">Streaming</span></a>
<a class="sourceLine" id="cb4-6" title="6">  (</a>
<a class="sourceLine" id="cb4-7" title="7">  )</a>
<a class="sourceLine" id="cb4-8" title="8"><span class="kw">where</span></a>
<a class="sourceLine" id="cb4-9" title="9"></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="kw">import</span> <span class="dt">Control.Applicative</span></a>
<a class="sourceLine" id="cb4-11" title="11"><span class="kw">import</span> <span class="dt">Control.Monad</span></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="kw">import</span> <span class="dt">Data.Functor</span></a>
<a class="sourceLine" id="cb4-13" title="13"><span class="kw">import</span> <span class="dt">Data.Functor.Identity</span></a>
<a class="sourceLine" id="cb4-14" title="14"><span class="kw">import</span> <span class="dt">Data.Monoid</span></a>
<a class="sourceLine" id="cb4-15" title="15"><span class="kw">import</span> <span class="dt">System.IO</span></a>
<a class="sourceLine" id="cb4-16" title="16"></a>
<a class="sourceLine" id="cb4-17" title="17"><span class="co">-- Represents a stream of elements of type a with an effect type f</span></a>
<a class="sourceLine" id="cb4-18" title="18"><span class="kw">data</span> <span class="dt">Stream</span> (<span class="ot">m ::</span> <span class="fu">*</span> <span class="ot">-&gt;</span> <span class="fu">*</span>) a <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-19" title="19">  <span class="dt">Yield</span><span class="ot"> ::</span> a <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a</a>
<a class="sourceLine" id="cb4-20" title="20">  <span class="dt">Await</span><span class="ot"> ::</span> m x <span class="ot">-&gt;</span> (x <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a) <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a</a>
<a class="sourceLine" id="cb4-21" title="21">  <span class="dt">Eff</span><span class="ot"> ::</span> m (<span class="dt">Stream</span> m a) <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a</a>
<a class="sourceLine" id="cb4-22" title="22">  <span class="dt">Done</span><span class="ot"> ::</span> m () <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a</a>
<a class="sourceLine" id="cb4-23" title="23"></a>
<a class="sourceLine" id="cb4-24" title="24"><span class="kw">instance</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Functor</span> (<span class="dt">Stream</span> m) <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-25" title="25">  <span class="fu">fmap</span> <span class="fu">=</span> liftM</a>
<a class="sourceLine" id="cb4-26" title="26"></a>
<a class="sourceLine" id="cb4-27" title="27"><span class="kw">instance</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Applicative</span> (<span class="dt">Stream</span> m) <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-28" title="28">  <span class="fu">pure</span> <span class="fu">=</span> <span class="fu">return</span></a>
<a class="sourceLine" id="cb4-29" title="29"></a>
<a class="sourceLine" id="cb4-30" title="30">  (<span class="fu">&lt;*&gt;</span>) <span class="fu">=</span> ap</a>
<a class="sourceLine" id="cb4-31" title="31"></a>
<a class="sourceLine" id="cb4-32" title="32"><span class="kw">instance</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Monad</span> (<span class="dt">Stream</span> m) <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-33" title="33">  <span class="fu">return</span> a <span class="fu">=</span> <span class="dt">Yield</span> a (<span class="dt">Done</span> (<span class="fu">return</span> ()))</a>
<a class="sourceLine" id="cb4-34" title="34"></a>
<a class="sourceLine" id="cb4-35" title="35">  (<span class="dt">Yield</span> a next) <span class="fu">&gt;&gt;=</span> f <span class="fu">=</span> (f a) <span class="fu">&lt;&gt;</span> (next <span class="fu">&gt;&gt;=</span> f)</a>
<a class="sourceLine" id="cb4-36" title="36">  (<span class="dt">Await</span> ma cont) <span class="fu">&gt;&gt;=</span> f <span class="fu">=</span> <span class="dt">Await</span> ma (cont <span class="fu">&gt;=&gt;</span> f)</a>
<a class="sourceLine" id="cb4-37" title="37">  (<span class="dt">Eff</span> ms) <span class="fu">&gt;&gt;=</span> f <span class="fu">=</span> <span class="dt">Eff</span> <span class="fu">.</span> <span class="fu">fmap</span> (<span class="fu">&gt;&gt;=</span> f) <span class="fu">$</span> ms</a>
<a class="sourceLine" id="cb4-38" title="38">  (<span class="dt">Done</span> close) <span class="fu">&gt;&gt;=</span> f <span class="fu">=</span> <span class="dt">Done</span> close</a>
<a class="sourceLine" id="cb4-39" title="39"></a>
<a class="sourceLine" id="cb4-40" title="40"><span class="kw">instance</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Semigroup</span> (<span class="dt">Stream</span> m a) <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-41" title="41">  (<span class="dt">Yield</span> a next) <span class="fu">&lt;&gt;</span> s <span class="fu">=</span> <span class="dt">Yield</span> a (next <span class="fu">&lt;&gt;</span> s)</a>
<a class="sourceLine" id="cb4-42" title="42">  (<span class="dt">Await</span> mx cont) <span class="fu">&lt;&gt;</span> s <span class="fu">=</span> <span class="dt">Await</span> mx ((<span class="fu">&lt;&gt;</span> s) <span class="fu">.</span> cont)</a>
<a class="sourceLine" id="cb4-43" title="43">  (<span class="dt">Eff</span> ms) <span class="fu">&lt;&gt;</span> s <span class="fu">=</span> <span class="dt">Eff</span> <span class="fu">.</span> <span class="fu">fmap</span> (<span class="fu">&lt;&gt;</span> s) <span class="fu">$</span> ms</a>
<a class="sourceLine" id="cb4-44" title="44">  (<span class="dt">Done</span> close) <span class="fu">&lt;&gt;</span> s <span class="fu">=</span> <span class="dt">Eff</span> <span class="fu">$</span> close <span class="fu">$&gt;</span> s</a>
<a class="sourceLine" id="cb4-45" title="45"></a>
<a class="sourceLine" id="cb4-46" title="46"><span class="kw">instance</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Monoid</span> (<span class="dt">Stream</span> m a) <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-47" title="47">  <span class="fu">mempty</span> <span class="fu">=</span> <span class="dt">Done</span> (<span class="fu">return</span> ())</a>
<a class="sourceLine" id="cb4-48" title="48">  <span class="fu">mappend</span> <span class="fu">=</span> (<span class="fu">&lt;&gt;</span>)</a>
<a class="sourceLine" id="cb4-49" title="49"></a>
<a class="sourceLine" id="cb4-50" title="50"><span class="ot">fromList ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a</a>
<a class="sourceLine" id="cb4-51" title="51">fromList [] <span class="fu">=</span> <span class="dt">Done</span> (<span class="fu">return</span> ())</a>
<a class="sourceLine" id="cb4-52" title="52">fromList (h <span class="fu">:</span> t) <span class="fu">=</span> <span class="dt">Yield</span> h (fromList t)</a>
<a class="sourceLine" id="cb4-53" title="53"></a>
<a class="sourceLine" id="cb4-54" title="54"><span class="ot">fromStdIn ::</span> <span class="dt">Stream</span> <span class="dt">IO</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb4-55" title="55">fromStdIn <span class="fu">=</span> <span class="dt">Await</span> <span class="fu">getLine</span> <span class="fu">return</span></a>
<a class="sourceLine" id="cb4-56" title="56"></a>
<a class="sourceLine" id="cb4-57" title="57"><span class="ot">fromFile ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Stream</span> <span class="dt">IO</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb4-58" title="58">fromFile file <span class="fu">=</span> <span class="dt">Await</span> handle cont</a>
<a class="sourceLine" id="cb4-59" title="59">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-60" title="60">    handle <span class="fu">=</span> (openFile file <span class="dt">ReadMode</span>) <span class="fu">&gt;&gt;=</span> handleStatus</a>
<a class="sourceLine" id="cb4-61" title="61">    handleStatus h <span class="fu">=</span> <span class="fu">fmap</span> (h,) (hIsEOF h)</a>
<a class="sourceLine" id="cb4-62" title="62">    cont (h, isClosed) <span class="fu">=</span></a>
<a class="sourceLine" id="cb4-63" title="63">      <span class="kw">if</span> (isClosed)</a>
<a class="sourceLine" id="cb4-64" title="64">        <span class="kw">then</span> <span class="dt">Done</span> (hClose h)</a>
<a class="sourceLine" id="cb4-65" title="65">        <span class="kw">else</span> <span class="dt">Await</span> (hGetLine h) (\s <span class="ot">-&gt;</span> <span class="dt">Yield</span> s (<span class="dt">Await</span> (handleStatus h) cont))</a>
<a class="sourceLine" id="cb4-66" title="66"></a>
<a class="sourceLine" id="cb4-67" title="67"><span class="co">-- This is very inefficient as it doesn't close streams early</span></a>
<a class="sourceLine" id="cb4-68" title="68"><span class="ot">takeS ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a</a>
<a class="sourceLine" id="cb4-69" title="69">takeS <span class="dv">0</span> s <span class="fu">=</span> <span class="kw">case</span> s <span class="kw">of</span></a>
<a class="sourceLine" id="cb4-70" title="70">  (<span class="dt">Yield</span> _ next) <span class="ot">-&gt;</span> takeS <span class="dv">0</span> next</a>
<a class="sourceLine" id="cb4-71" title="71">  s<span class="fu">@</span>(<span class="dt">Await</span> mx cont) <span class="ot">-&gt;</span> <span class="dt">Await</span> mx (takeS <span class="dv">0</span> <span class="fu">.</span> cont)</a>
<a class="sourceLine" id="cb4-72" title="72">  (<span class="dt">Done</span> close) <span class="ot">-&gt;</span> <span class="dt">Done</span> close</a>
<a class="sourceLine" id="cb4-73" title="73">takeS n s <span class="fu">=</span> <span class="kw">case</span> s <span class="kw">of</span></a>
<a class="sourceLine" id="cb4-74" title="74">  (<span class="dt">Yield</span> ma next) <span class="ot">-&gt;</span> <span class="dt">Yield</span> ma (takeS (n <span class="fu">-</span><span class="dv">1</span>) next)</a>
<a class="sourceLine" id="cb4-75" title="75">  (<span class="dt">Await</span> mx cont) <span class="ot">-&gt;</span> <span class="dt">Await</span> mx (takeS n <span class="fu">.</span> cont)</a>
<a class="sourceLine" id="cb4-76" title="76">  (<span class="dt">Done</span> close) <span class="ot">-&gt;</span> <span class="dt">Done</span> close</a>
<a class="sourceLine" id="cb4-77" title="77"></a>
<a class="sourceLine" id="cb4-78" title="78"><span class="ot">toFile ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Stream</span> <span class="dt">IO</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb4-79" title="79">toFile file stream <span class="fu">=</span> withFile file <span class="dt">WriteMode</span> <span class="fu">$</span> \h <span class="ot">-&gt;</span> drain <span class="fu">.</span> mapF (hPutStrLn h) <span class="fu">$</span> stream</a>
<a class="sourceLine" id="cb4-80" title="80"></a>
<a class="sourceLine" id="cb4-81" title="81"><span class="ot">toList ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Stream</span> m a <span class="ot">-&gt;</span> m [a]</a>
<a class="sourceLine" id="cb4-82" title="82">toList (<span class="dt">Yield</span> a next) <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-83" title="83">  t <span class="ot">&lt;-</span> toList next</a>
<a class="sourceLine" id="cb4-84" title="84">  <span class="fu">return</span> (a <span class="fu">:</span> t)</a>
<a class="sourceLine" id="cb4-85" title="85">toList (<span class="dt">Await</span> ma cont) <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-86" title="86">  a <span class="ot">&lt;-</span> ma</a>
<a class="sourceLine" id="cb4-87" title="87">  toList (cont a)</a>
<a class="sourceLine" id="cb4-88" title="88">toList (<span class="dt">Eff</span> ms) <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-89" title="89">  s <span class="ot">&lt;-</span> ms</a>
<a class="sourceLine" id="cb4-90" title="90">  toList s</a>
<a class="sourceLine" id="cb4-91" title="91">toList (<span class="dt">Done</span> close) <span class="fu">=</span> close <span class="fu">&gt;&gt;</span> <span class="fu">return</span> []</a>
<a class="sourceLine" id="cb4-92" title="92"></a>
<a class="sourceLine" id="cb4-93" title="93"><span class="ot">fold ::</span> (<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> (b <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> b <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a <span class="ot">-&gt;</span> m b</a>
<a class="sourceLine" id="cb4-94" title="94">fold f b (<span class="dt">Yield</span> a next) <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-95" title="95">  <span class="kw">let</span> b' <span class="fu">=</span> f b a</a>
<a class="sourceLine" id="cb4-96" title="96">  fold f (b') next</a>
<a class="sourceLine" id="cb4-97" title="97">fold f b (<span class="dt">Await</span> ma cont) <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-98" title="98">  a <span class="ot">&lt;-</span> ma</a>
<a class="sourceLine" id="cb4-99" title="99">  fold f b (cont a)</a>
<a class="sourceLine" id="cb4-100" title="100">fold f b (<span class="dt">Eff</span> ms) <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-101" title="101">  s <span class="ot">&lt;-</span> ms</a>
<a class="sourceLine" id="cb4-102" title="102">  fold f b s</a>
<a class="sourceLine" id="cb4-103" title="103">fold _ b (<span class="dt">Done</span> close) <span class="fu">=</span> close <span class="fu">&gt;&gt;</span> <span class="fu">return</span> b</a>
<a class="sourceLine" id="cb4-104" title="104"></a>
<a class="sourceLine" id="cb4-105" title="105"><span class="ot">foldMonoid ::</span> (<span class="dt">Monad</span> m, <span class="dt">Monoid</span> a) <span class="ot">=&gt;</span> <span class="dt">Stream</span> m a <span class="ot">-&gt;</span> m a</a>
<a class="sourceLine" id="cb4-106" title="106">foldMonoid <span class="fu">=</span> fold (<span class="fu">&lt;&gt;</span>) <span class="fu">mempty</span></a>
<a class="sourceLine" id="cb4-107" title="107"></a>
<a class="sourceLine" id="cb4-108" title="108"><span class="co">-- Run a stream purely for its effects</span></a>
<a class="sourceLine" id="cb4-109" title="109"><span class="ot">drain ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Stream</span> m a <span class="ot">-&gt;</span> m ()</a>
<a class="sourceLine" id="cb4-110" title="110">drain (<span class="dt">Yield</span> a next) <span class="fu">=</span> drain next</a>
<a class="sourceLine" id="cb4-111" title="111">drain (<span class="dt">Await</span> ma cont) <span class="fu">=</span> ma <span class="fu">&gt;&gt;=</span> (drain <span class="fu">.</span> cont)</a>
<a class="sourceLine" id="cb4-112" title="112">drain (<span class="dt">Eff</span> ms) <span class="fu">=</span> ms <span class="fu">&gt;&gt;=</span> drain</a>
<a class="sourceLine" id="cb4-113" title="113">drain (<span class="dt">Done</span> close) <span class="fu">=</span> close</a>
<a class="sourceLine" id="cb4-114" title="114"></a>
<a class="sourceLine" id="cb4-115" title="115"><span class="co">-- Map an effectful computation across a stream</span></a>
<a class="sourceLine" id="cb4-116" title="116"><span class="ot">mapF ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> m b) <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a <span class="ot">-&gt;</span> <span class="dt">Stream</span> m b</a>
<a class="sourceLine" id="cb4-117" title="117">mapF f (<span class="dt">Yield</span> a next) <span class="fu">=</span> <span class="dt">Await</span> (f a) (<span class="fu">const</span> (mapF f next))</a>
<a class="sourceLine" id="cb4-118" title="118">mapF f (<span class="dt">Await</span> ma cont) <span class="fu">=</span> <span class="dt">Await</span> ma (mapF f <span class="fu">.</span> cont)</a>
<a class="sourceLine" id="cb4-119" title="119">mapF f (<span class="dt">Eff</span> ms) <span class="fu">=</span> <span class="dt">Eff</span> <span class="fu">.</span> <span class="fu">fmap</span> (mapF f) <span class="fu">$</span> ms</a>
<a class="sourceLine" id="cb4-120" title="120">mapF _ (<span class="dt">Done</span> close) <span class="fu">=</span> <span class="dt">Done</span> close</a>
<a class="sourceLine" id="cb4-121" title="121"></a>
<a class="sourceLine" id="cb4-122" title="122"><span class="ot">filterS ::</span> <span class="dt">Functor</span> m <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> <span class="dt">Bool</span>) <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a <span class="ot">-&gt;</span> <span class="dt">Stream</span> m a</a>
<a class="sourceLine" id="cb4-123" title="123">filterS f (<span class="dt">Yield</span> a next) <span class="fu">=</span> <span class="kw">if</span> f a <span class="kw">then</span> <span class="dt">Yield</span> a (filterS f next) <span class="kw">else</span> filterS f next</a>
<a class="sourceLine" id="cb4-124" title="124">filterS f (<span class="dt">Await</span> ma cont) <span class="fu">=</span> <span class="dt">Await</span> ma (filterS f <span class="fu">.</span> cont)</a>
<a class="sourceLine" id="cb4-125" title="125">filterS f (<span class="dt">Eff</span> ms) <span class="fu">=</span> <span class="dt">Eff</span> <span class="fu">.</span> <span class="fu">fmap</span> (filterS f) <span class="fu">$</span> ms</a>
<a class="sourceLine" id="cb4-126" title="126">filterS _ (<span class="dt">Done</span> close) <span class="fu">=</span> <span class="dt">Done</span> close</a>
<a class="sourceLine" id="cb4-127" title="127"></a>
<a class="sourceLine" id="cb4-128" title="128"><span class="co">-- Print each line in /tmp/data in turn</span></a>
<a class="sourceLine" id="cb4-129" title="129"><span class="ot">example1 ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb4-130" title="130">example1 <span class="fu">=</span> drain <span class="fu">.</span> mapF <span class="fu">putStrLn</span> <span class="fu">$</span> fromFile <span class="st">&quot;/tmp/data&quot;</span></a>
<a class="sourceLine" id="cb4-131" title="131"></a>
<a class="sourceLine" id="cb4-132" title="132"><span class="co">-- Duplicate every element in the input list -&gt; [1,1,2,2,3,3]</span></a>
<a class="sourceLine" id="cb4-133" title="133"><span class="ot">example2 ::</span> [<span class="dt">Int</span>]</a>
<a class="sourceLine" id="cb4-134" title="134">example2 <span class="fu">=</span> runIdentity <span class="fu">.</span> toList <span class="fu">.</span> (<span class="fu">&gt;&gt;=</span> \x <span class="ot">-&gt;</span> <span class="fu">return</span> x <span class="fu">&lt;&gt;</span> <span class="fu">return</span> x) <span class="fu">$</span> fromList [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>]</a>
<a class="sourceLine" id="cb4-135" title="135"></a>
<a class="sourceLine" id="cb4-136" title="136"><span class="co">-- Concatenate files to list</span></a>
<a class="sourceLine" id="cb4-137" title="137"><span class="ot">example3 ::</span> <span class="dt">IO</span> [<span class="dt">String</span>]</a>
<a class="sourceLine" id="cb4-138" title="138">example3 <span class="fu">=</span> toList <span class="fu">$</span> (fromFile <span class="st">&quot;/tmp/data&quot;</span>) <span class="fu">&lt;&gt;</span> (fromFile <span class="st">&quot;/tmp/data2&quot;</span>)</a>
<a class="sourceLine" id="cb4-139" title="139"></a>
<a class="sourceLine" id="cb4-140" title="140"><span class="co">-- Sum list</span></a>
<a class="sourceLine" id="cb4-141" title="141"><span class="ot">example4 ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb4-142" title="142">example4 <span class="fu">=</span> getSum <span class="fu">.</span> runIdentity <span class="fu">.</span> foldMonoid <span class="fu">.</span> <span class="fu">fmap</span> <span class="dt">Sum</span> <span class="fu">$</span> fromList [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>]</a>
<a class="sourceLine" id="cb4-143" title="143"></a>
<a class="sourceLine" id="cb4-144" title="144"><span class="co">-- Copy file</span></a>
<a class="sourceLine" id="cb4-145" title="145"><span class="ot">example5 ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb4-146" title="146">example5 <span class="fu">=</span> toFile <span class="st">&quot;/tmp/copy&quot;</span> <span class="fu">$</span> fromFile <span class="st">&quot;/tmp/data&quot;</span></a>
<a class="sourceLine" id="cb4-147" title="147"></a>
<a class="sourceLine" id="cb4-148" title="148"><span class="co">-- Take from list -&gt; [1,2,3]</span></a>
<a class="sourceLine" id="cb4-149" title="149"><span class="ot">example6 ::</span> [<span class="dt">Int</span>]</a>
<a class="sourceLine" id="cb4-150" title="150">example6 <span class="fu">=</span> runIdentity <span class="fu">.</span> toList <span class="fu">.</span> takeS <span class="dv">3</span> <span class="fu">$</span> fromList [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>]</a>
<a class="sourceLine" id="cb4-151" title="151"></a>
<a class="sourceLine" id="cb4-152" title="152"><span class="co">-- Filter list -&gt; prints 2 4</span></a>
<a class="sourceLine" id="cb4-153" title="153"><span class="ot">example7 ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb4-154" title="154">example7 <span class="fu">=</span> drain <span class="fu">.</span> mapF <span class="fu">print</span> <span class="fu">.</span> filterS <span class="fu">even</span> <span class="fu">.</span> fromList <span class="fu">$</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>]<span class="ot"> ::</span> <span class="dt">IO</span> ()</a></code></pre></div>
    </section>
</article>

        </main>

        <footer>
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </footer>
    </body>
</html>
